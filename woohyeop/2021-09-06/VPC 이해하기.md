# VPC 이해하기

VPC를 만들면서 이해해보자.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled.png)

VPC 생성하면 뜨는 창은 위와 같다. 여기서 필수적으로 입력해주어야 하는 값은 IPv4 CIDR 블록인데, 이는 VPC의 크기를 지정해주는 것이다. IP주소/넷마스크 형식으로 써 주어야 하는데, 필자는 10.0.10.0/24라고 IP 범위를 지정해주었다. 여기서 넷마스크는 IP 내에서 고정된 비트 수를 의미한다. 따라서, 10.0.10.0/24는 10.0.10.0부터 10.0.10.255까지의 IP를 의미한다.

클라우드에서 생성하는 자원들은 기본적으로 특정 네트워크 위에서 생성되며, 이에 접근하기 위한 Private IP를 지닌다. 해당하는 리소스들은 당연히 특정 VPC 위에서 만들어지게 되고, 따라서, VPC의 CIDR 블록에 지정한 범위내에서 적절한 IP를 할당받게 된다. 하나의 VPC가 가질 수 있는 최소 넷마스크는 16이고, 이 말은 즉슨, 최대 65535(2^16)개의 IP를 사용할 수 있다는 말이다.

VPC의 범위와 공인 IP가 겹치면 어떻게 될까? 이따가, 라우팅 테이블을 설명하면서 할 것이지만, 먼저 정답을 공개하자면, VPC에 먼저 접근하게 된다. 따라서, CIDR 블록을 사설망 범위에 두어야 하고, 인터넷 연결을 하지 않는다고 하더라도, 해당 범위를 사설망에 두는 것이 국룰이자 권장되는 바이다. VPC는 독립된 네트워크 환경으로 구성되기 때문에, CIDR 블록이 같더라도 문제가 되지 않는데, 다수의 VPC를 사용할 경우에 IP 대역이 겹쳤다면 이는 문제가 될 수 있다. VPC를 만드는 것은 쉬우나 그걸 변경하는 것은 어렵다. 기본으로 AWS에서 만들어주는 VPC의 CIDR 블록은 172.31.0.0/16이다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%201.png)

성공적으로 VPC를 만들었다.

그런데, 다른 친구들이 여럿 같이 생겼다.

먼저, 라우팅 테이블이다. 라우트 테이블은 VPC를 생성할 때 만들어지고, 기본으로 만들어진 라우트 테이블은 이후에 설명하겠지만, VPC에 속한 서브넷을 만들 때 이용한다. 자동 생성되는 라우트 테이블에는 한 가지의 룰이 정의되어 있는데, VPC의 CIDR 블록을 목적지로 하는 경우, 타겟이 local이라는 규칙이다. 

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%202.png)

이 기본 규칙은 삭제할 수 없으며, 인터넷에 연결하거나 다른 VPC와 통신하기 위해서는 라우트 테이블에 라우트 규칙을 추가해 주어야 한다. 아까, Public IP와 Private IP가 겹칠 때, Private IP에 우선적으로 이동하는 것이 이 규칙에 따른 것이다.

다음으로 설명할 것은 DHCP 옵션 셋이다. DHCP 옵션 셋은 도메인 네임 서버, 도메인 네임, NTP 서버, NetBIOS 서버 등의 정보를 가지고 있다. 일반적으로는 기본값을 그대로 사용한다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%203.png)

VPC의 보안을 담당하는 네트워크 ACL과 보안 그룹(Security Group) 리소스도 같이 생성된다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%204.png)

ACL은 서브넷의 앞단에서 방화벽 역할을 하는 리소스입니다. ACL에는 인바운드와 아운바운드 규칙이 따로 있습니다. VPC와 함께 생성되는 ACL에는 인바운드와 아웃바운드 규칙 각각 2개의 규칙을 가지고 있습니다. 규칙의 번호는 우선 순위를 나타냅니다. 번호가 *인 규칙은 다른 어떤 룰에도 매치하지 않을 경우 사용하는 기본 규칙입니다. 이미지에서 확인할 수 있듯이 기본 규칙은 모든 트래픽을 차단Deny합니다. 하지만 이 ACL에서는 기본 규칙이 사용되지 않습니다. 왜냐하면 100번 규칙에서 모든 트래픽을 허용하고 있기 때문입니다.

하나의 네트워크 ACL을 다수의 서브넷에서 사용할 수 있다.

EC2를 자주 사용했다면, ACL 보다는 보안 그룹에 더 익숙할 수밖에 없는데, **보안 그룹은 인스턴스의 앞단에서 트래픽을 제어하는 가상 방화벽**인 반면, **네트워크 ACL은 서브넷 앞단에서 트래픽을 제어하는 역할**을 하기 때문이다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%205.png)

VPC를 만들 때 생성되는 보안 그룹은 VPC 내부의 통신을 허용하기 위한 특별한 규칙을 가지고 있다. 먼저, 이 보안 그룹의 아웃바운드 규칙은 모든 트래픽에 대해서 허용되어있다. 반면에, 인바운드 규칙은 소스(Source)에는 일반적으로 CIDR을 지정한다. 흥미로운 건 **CIDR 대신 보안 그룹의 ID를 지정**한다는 것이고, 이를 **통**해, ****해당하는 보안 그룹을 가진 리소스에 대해서만 트래픽을 허용할 수 있다. 따라서, VPC 내부의 리소스들이 통신을 하기 위해서는 각각의 리소스들이 모두 이 보안 그룹을 사용해야 한다.

지금까지 VPC를 만들었고, 그에 따라 부차적으로 만들어진 라우팅 테이블, DHCP 옵션 셋, 네트워크 ACL, 보안 그룹에 대해 설명했다.

이젠 틈틈이 언급되던 서브넷을 만들어볼 차례이다. VPC만 가지고는 아직 아무것도 할 수 없다. 

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%206.png)

[https://medium.com/harrythegreat/aws-가장쉽게-vpc-개념잡기-71eef95a7098](https://medium.com/harrythegreat/aws-%EA%B0%80%EC%9E%A5%EC%89%BD%EA%B2%8C-vpc-%EA%B0%9C%EB%85%90%EC%9E%A1%EA%B8%B0-71eef95a7098)

VPC를 다시 한 번 CIDR 블록으로 나눠서, 실제로 리소스가 생성되는 물리적 공간과 연결해야 한다. 이러한 역할을 서브넷이 수행한다. VPC가 논리적인 구획을 나눠주는 네트워크라면, 서브넷은 VPC 안에서 실제 리소스가 생성될 수 있는 물리적 공간인 가용 영역에 연결된 네트워크라고 생각하면 된다고 한다. 즉, VPC 위에 EC2 인스턴스를 올리는 것이 아니라, 서브넷 위에 올리는 것이다.

다른 서비스에서 리소스를 생성할 때, VPC만 지정할 수는 없다. VPC와 서브넷을 모두 지정하거나, 서브넷만 지정하면 VPC가 자동으로 유추되기도 한다.

하나의 VPC는 N개의 서브넷을 가질 수 있으며, 서브넷의 최대 크기는 VPC의 크기와 같다. VPC와 동일하게 하나의 서브넷만 두어도 되고, VPC의 크기만큼 서브넷을 만들어도 된다. 일반적으로 사용할 수 있는 범위를 고려해 적절한 크기의 서브넷을 생성해서 사용한다. 이렇게, 리소스를 분산하는 것이 재해 대응 측면에서도 유리하다.

서브넷의 넷마스크 범위는 16(65535개)에서 28(16개)를 사용할 수 있고, 이 범위는 VPC에 속하는 것이어야 한다. 

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%207.png)

서브넷 이름, 즉, 태그를 만드는 것은 옵션이고, 가용 영역은 6개가 존재하는 데, 그중에서 한 개를 택했다. IPv4 CIDR 블록은 당연히 선택한 VPC의 IP 범위에 속하는 것으로 지정해야 한다. 같은 방법으로, us-east-1b를 가용 영역으로, 10.0.10.16/28을 CIDR 블록으로 가지는 서브넷을 한 개 더 만들어 줬다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%208.png)

왜 서브넷을 2개 만드나요?

이 예제에서는 서브넷을 2개 만들었습니다. 서브넷을 2개 만드는 게 의아하게 느껴질 수도 있습니다. 가용존 하나와 연결된 하나의 서브넷만 있더라도 EC2 인스턴스를 생성하는 것은 가능합니다. 하지만 EC2를 비롯한 많은 AWS의 서비스에서는 멀티AZ라는 개념을 지원하고 있습니다. 이는 **하나 이상의 가용존에 유사한 리소스를 동시에 배치**하는 기능입니다.

이렇게 하는 이유는 장애 대응과 관련이 있습니다. 하나의 리전에는 다수의 가용존들이 있습니다. 이 가용존은 단순히 가상적으로 분리되어있는 것이 아니고, 물리적인 공간도 분리되어있습니다. 따라서, **다수의 가용존에 유사한 리소스를 배치함으로써 하나의 가용존에 문제가 생기더라도 서비스에 장애가 발생하지 않도록 설계하는 것이 가능**합니다. AWS에서는 리전 당 2개 이상의 가용존을 제공하며, 2개 이상의 가용존(서브넷)을 전제로 네트워크를 설계하는 것을 권장합니다.

서브넷을 만든다고 추가 비용이 발생하는 것은 아니므로, 여기서도 2개를 만들었습니다. 기존 VPC에 속한 서브넷 역시 리전에서 제공하는 가용존 수만큼 생성되어있습니다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%209.png)

가용존 us-east-1b를 연결하고 있는 서브넷 위에 EC2 인스턴스 하나를 올렸다.

```
brwook@ubuntu:~$ telnet 54.226.77.56 22
Trying 54.226.77.56...
```

보안 그룹을 보면, 22번 포트를 허용하고 있다. 또한, 네트워크 ACL도 모든 소스로부터의 트래픽을 허용하고 있는 상태이다. 마지막으로, 인스턴스 생성 시에 공인 IP 할당을 자동화했다. 그러면, 이는 당연히 telnet 연결이 되어야 하는데 아무런 응답이 없다.

외부에서 EC2 인스턴스에 접속하기 위해서는, 해당하는 인스턴스에서 인터넷 액세스가 활성화되어 있어야 한다. 아래는 아마존 공식 문서에서 나온 것이다.

```
VPC 서브넷의 인스턴스에 대한 인터넷 액세스를 활성화하려면 다음을 수행해야 합니다.

- VPC에 인터넷 게이트웨이를 연결합니다.
- 서브넷의 라우팅 테이블이 인터넷 게이트웨이를 가리키는지 확인합니다.
- 서브넷의 인스턴스에 전역적으로 고유한 IP 주소(퍼블릭 IPv4 주소, 탄력적 IP 주소 또는 IPv6 주소)가 있는지 확인합니다.
- 네트워크 액세스 제어 및 보안 그룹 규칙에서 적절한 트래픽이 인스턴스로, 그리고 인스턴스에서 흐르도록 허용되는지 확인합니다.
```

여기서 문제는 첫 번째와 두 번째 조건이다.

VPC에 인터넷 게이트웨이를 연결하고, 라우팅 테이블과 서브넷과 연결해보자. 서브넷에서 네트워크를 이용할 때, 이 라우팅 테이블을 통해 목적지에 도착한다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%2010.png)

인터넷 게이트웨이를 하나 만들었다. 막 따끈따끈하게 만들어진 상태라, Detachd 상태이다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%2011.png)

이를 이전에 만든 VPC에 연결해준다. 이제 VPC와 인터넷 게이트웨이가 연결되었다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%2012.png)

이제 VPC와 그 산하의 서브넷에 연결된 라우팅 테이블의 규칙을 보면 위와 같다. 즉, VPC 내부 연결을 위한 규칙만이 만들어져 있는 상태이다.

![Untitled](VPC%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5%20ff05d4f5fc7246a8b8ddf5ee121e44ef/Untitled%2013.png)

목적지를 0.0.0.0/0으로 설정하고, 타겟으로는 앞서 생성한 인터넷 게이트웨이로 했다. 첫 번째 규칙이 우선하여 내부 네트워크에 해당하는 목적지인지 확인하고, 그렇지 않다면 두 번째 규칙으로 인해, 인터넷 게이트웨이로 라우트하게 된다.

```
brwook@ubuntu:~$ telnet 54.226.77.56 22
Trying 54.226.77.56...
Connected to 54.226.77.56.
Escape character is '^]'.
SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.2
```

이제 잘 연결이 된다.

이렇게 만든 것이, 실제 계정 생성 시에 자동으로 만들어지는 VPC와 거의 같은 상태이다.

```
- 1 VPC
- n 서브넷Subnet
- 1 라우트 테이블Route Table
- 1 네트워크 ACLNetwork ACL
- 1 시큐리티 그룹Security Group
- 1 인터넷 게이트웨이Internet Gateway
- 1 DHCP 옵션셋DHCP options set
```